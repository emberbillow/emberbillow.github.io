<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜å·®å‡½æ•°ä¸ç©ºé—´éšæœºåœºæ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .algorithm-badge {
            text-align: center;
            margin-bottom: 20px;
        }
        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .control-item {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            color: #34495e;
            margin-bottom: 8px;
            font-size: 14px;
        }
        select, input[type="number"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
        }
        .param-description {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }
        button {
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        button:active {
            transform: translateY(0);
        }
        .generate-btn {
            display: block;
            margin: 20px auto 0;
        }
        .visualization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .field-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .field-title {
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        canvas {
            display: block;
            margin: 0 auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        .variogram-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .variogram-title {
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 15px;
        }
        .stat-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        .info-box h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .info-box p {
            color: #555;
            line-height: 1.6;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š å˜å·®å‡½æ•°ä¸ç©ºé—´éšæœºåœºæ¼”ç¤ºç³»ç»Ÿ</h1>
        <div class="subtitle">åœ°ç»Ÿè®¡å­¦æ•™å­¦å·¥å…· - ç›´è§‚ç†è§£å˜å·®å‡½æ•°ç»“æ„å¯¹ç©ºé—´æ¨¡å¼çš„å½±å“</div>
        <div class="algorithm-badge">
            <span class="badge">âš¡ ä½¿ç”¨Choleskyåˆ†è§£ç®—æ³•ç”Ÿæˆï¼ˆåŸºäºåæ–¹å·®çŸ©é˜µï¼‰</span>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label>å˜å·®å‡½æ•°ç±»å‹</label>
                    <select id="variogramType">
                        <option value="spherical">çƒçŠ¶æ¨¡å‹ (Spherical)</option>
                        <option value="exponential" selected>æŒ‡æ•°æ¨¡å‹ (Exponential)</option>
                        <option value="gaussian">é«˜æ–¯æ¨¡å‹ (Gaussian)</option>
                        <option value="linear">çº¿æ€§æ¨¡å‹ (Linear)</option>
                        <option value="nugget">çº¯å—é‡‘æ•ˆåº” (Pure Nugget)</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label>å—é‡‘å€¼ (Nugget) Câ‚€</label>
                    <input type="number" id="nugget" value="0.0" min="0" max="1" step="0.1">
                    <div class="param-description">çŸ­è·ç¦»å˜å¼‚ï¼Œé€šå¸¸ç”±æµ‹é‡è¯¯å·®å¼•èµ·</div>
                </div>
                
                <div class="control-item">
                    <label>åŸºå°å€¼ (Sill) Câ‚€+C</label>
                    <input type="number" id="sill" value="1.0" min="0.1" max="5" step="0.1">
                    <div class="param-description">æ€»çš„ç©ºé—´å˜å¼‚æ€§ï¼ˆæ ‡å‡†å·®çš„å¹³æ–¹ï¼‰</div>
                </div>
                
                <div class="control-item">
                    <label>å˜ç¨‹ (Range) a</label>
                    <input type="number" id="range" value="20" min="5" max="80" step="5">
                    <div class="param-description">ç©ºé—´ç›¸å…³æ€§çš„æœ‰æ•ˆè·ç¦»ï¼ˆåƒç´ å•ä½ï¼‰</div>
                </div>
                
                <div class="control-item">
                    <label>ç½‘æ ¼å¤§å°</label>
                    <input type="number" id="gridSize" value="32" min="8" max="128" step="8">
                    <div class="param-description">éšæœºåœºçš„åˆ†è¾¨ç‡ï¼Œè‡ªå®šä¹‰è®¾ç½®ï¼ˆCholeskyé€‚ç”¨äºå°ç½‘æ ¼ï¼Œnâ‰¤128è®¡ç®—å¯†é›†ï¼Œå¯èƒ½ææ…¢ï¼‰</div>
                </div>
                
                <div class="control-item">
                    <label>å„å‘å¼‚æ€§æ¯” (X/Y)</label>
                    <input type="number" id="anisotropy" value="1.0" min="0.2" max="5" step="0.1">
                    <div class="param-description">1.0=å„å‘åŒæ€§ï¼Œ>1æ°´å¹³æ–¹å‘ç›¸å…³æ€§æ›´å¼º</div>
                </div>
            </div>
            
            <button class="generate-btn" onclick="generateFields()">ğŸ² ç”Ÿæˆéšæœºåœº</button>
        </div>
        
        <div class="visualization">
            <div class="field-container">
                <div class="field-title">éšæœºåœºå®ç° #1</div>
                <canvas id="field1" width="400" height="400"></canvas>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-label">å‡å€¼</div>
                        <div class="stat-value" id="mean1">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ ‡å‡†å·®</div>
                        <div class="stat-value" id="std1">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€å°å€¼</div>
                        <div class="stat-value" id="min1">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€å¤§å€¼</div>
                        <div class="stat-value" id="max1">-</div>
                    </div>
                </div>
            </div>
            
            <div class="field-container">
                <div class="field-title">éšæœºåœºå®ç° #2</div>
                <canvas id="field2" width="400" height="400"></canvas>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-label">å‡å€¼</div>
                        <div class="stat-value" id="mean2">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ ‡å‡†å·®</div>
                        <div class="stat-value" id="std2">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€å°å€¼</div>
                        <div class="stat-value" id="min2">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€å¤§å€¼</div>
                        <div class="stat-value" id="max2">-</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="variogram-container">
            <div class="variogram-title">ç†è®ºå˜å·®å‡½æ•° Î³(h)</div>
            <canvas id="variogram" width="800" height="400"></canvas>
        </div>
        
        <div class="info-box">
            <h3>ğŸ’¡ ç®—æ³•åŸç†ï¼šåŸºäºåæ–¹å·®çŸ©é˜µçš„Choleskyåˆ†è§£æ–¹æ³•</h3>
            <p>
                <strong>ç®—æ³•æ­¥éª¤ï¼š</strong><br>
                1. æ„å»ºåæ–¹å·®çŸ©é˜µ C_{pq} = åæ–¹å·®( \sqrt{ (Î”x / l_x)^2 + (Î”y / l_y)^2 } )ï¼Œå…¶ä¸­ l_x = a/3, l_y = l_x / å„å‘å¼‚æ€§æ¯”<br>
                2. æ·»åŠ å¾®å°æ­£åˆ™åŒ–ï¼ˆÎµ â‰ˆ 10^{-10} Ã— sillï¼‰åˆ°å¯¹è§’çº¿ä»¥ç¡®ä¿æ•°å€¼ç¨³å®šæ€§ï¼ˆå°¤å…¶å¯¹é«˜æ–¯æ¨¡å‹ï¼‰<br>
                3. Choleskyåˆ†è§£ï¼šC = L L^Tï¼ŒL ä¸ºä¸‹ä¸‰è§’çŸ©é˜µ<br>
                4. ç”Ÿæˆç‹¬ç«‹æ ‡å‡†æ­£æ€éšæœºå‘é‡ Z ~ N(0, I)<br>
                5. éšæœºåœº X = L Zï¼ˆçŸ©é˜µ-å‘é‡ä¹˜æ³•ï¼‰<br>
                6. æ ‡å‡†åŒ–åˆ°å‡å€¼ 0 å’Œæ ‡å‡†å·® âˆšsill<br><br>
                <strong>å…³é”®ç‚¹ï¼š</strong><br>
                â€¢ ç²¾ç¡®ç”Ÿæˆæœ‰é™ç½‘æ ¼ä¸Šçš„å¤šå˜é‡é«˜æ–¯éšæœºåœº<br>
                â€¢ è®¡ç®—å¤æ‚åº¦ O((nÂ²)^3) = O(n^6)ï¼Œä»…é€‚ç”¨äºå°ç½‘æ ¼ï¼ˆnâ‰¤64è¾ƒæ…¢ï¼Œn=128å¯èƒ½ææ…¢æˆ–å†…å­˜ä¸è¶³ï¼‰<br>
                â€¢ å¯¹äºå¤§ç½‘æ ¼ï¼ŒFFTæ–¹æ³•æ›´é«˜æ•ˆï¼ˆO(nÂ² log n)ï¼‰<br>
                â€¢ å˜ç¨‹å‚æ•°é™¤ä»¥3æ˜¯ä¸ºäº†åŒ¹é…ä¸åŒæ¨¡å‹çš„æœ‰æ•ˆè·ç¦»<br>
                â€¢ <strong>é«˜æ–¯æ¨¡å‹ç¨³å®šæ€§ï¼š</strong>å¹³æ»‘åæ–¹å·®å‡½æ•°åœ¨ç¦»æ•£ç½‘æ ¼ä¸Šå¯èƒ½å¯¼è‡´æ•°å€¼ä¸ç¨³å®šï¼Œå·²é€šè¿‡å¯¹è§’æ­£åˆ™åŒ–ä¿®å¤ï¼Œç¡®ä¿ç”Ÿæˆæœ‰ç©ºé—´å˜å¼‚çš„åœº<br><br>
                <strong>å˜å·®å‡½æ•°å‚æ•°ï¼š</strong><br>
                â€¢ <strong>å—é‡‘å€¼ (Câ‚€)ï¼š</strong>hâ†’0æ—¶çš„å˜å·®å€¼ï¼Œåæ˜ å¾®è§‚å˜å¼‚<br>
                â€¢ <strong>åŸºå°å€¼ (Câ‚€+C)ï¼š</strong>æ€»æ–¹å·®ï¼Œæ§åˆ¶åœºçš„æ•´ä½“å˜å¼‚å¹…åº¦<br>
                â€¢ <strong>å˜ç¨‹ (a)ï¼š</strong>æœ‰æ•ˆç›¸å…³è·ç¦»ï¼Œæ§åˆ¶ç©ºé—´ç»“æ„çš„å°ºåº¦<br>
                â€¢ <strong>å„å‘å¼‚æ€§ï¼š</strong>ä¸åŒæ–¹å‘çš„ç›¸å…³é•¿åº¦æ¯”<br><br>
                <strong>è§‚å¯Ÿè¦ç‚¹ï¼š</strong><br>
                â€¢ å˜ç¨‹è¶Šå¤§ â†’ æ–‘å—è¶Šå¤§ã€è¶Šè¿ç»­<br>
                â€¢ å—é‡‘å€¼è¶Šå¤§ â†’ åœºè¶Š"é¢—ç²’åŒ–"ã€ä¸è¿ç»­<br>
                â€¢ æŒ‡æ•°æ¨¡å‹ â†’ ç›¸å¯¹ç²—ç³™<br>
                â€¢ é«˜æ–¯æ¨¡å‹ â†’ éå¸¸å¹³æ»‘<br>
                â€¢ çƒçŠ¶æ¨¡å‹ â†’ ä»‹äºä¸¤è€…ä¹‹é—´
            </p>
        </div>
    </div>

    <script>
        // ============ æ ‡å‡†æ­£æ€éšæœºæ•°ç”Ÿæˆ (Box-Mullerå˜æ¢) ============
        function gaussianRandom() {
            const u = 1 - Math.random();
            const v = 1 - Math.random();
            const r = Math.sqrt(-2 * Math.log(u));
            const theta = 2 * Math.PI * v;
            return r * Math.cos(theta);
        }

        // ============ Choleskyåˆ†è§£ ============
        function choleskyDecomposition(A) {
            const n = A.length;
            const L = Array.from({length: n}, () => new Float64Array(n).fill(0));
            
            for (let i = 0; i < n; i++) {
                for (let j = 0; j <= i; j++) {
                    let sum = 0;
                    for (let k = 0; k < j; k++) {
                        sum += L[i][k] * L[j][k];
                    }
                    if (i === j) {
                        const diag = A[i][i] - sum;
                        if (diag <= 0) {
                            throw new Error(`çŸ©é˜µéæ­£å®š: å¯¹è§’å…ƒç´  ${diag} <= 0 at ${i}`);
                        }
                        L[i][j] = Math.sqrt(diag);
                    } else {
                        L[i][j] = (A[i][j] - sum) / L[j][j];
                    }
                }
            }
            return L;
        }

        // ============ å˜å·®å‡½æ•°å’Œåæ–¹å·®å‡½æ•° ============
        function variogram(h, type, nugget, sill, range) {
            if (h === 0) return 0;
            
            const partialSill = sill - nugget;
            
            switch(type) {
                case 'spherical':
                    if (h >= range) return sill;
                    const hr = h / range;
                    return nugget + partialSill * (1.5 * hr - 0.5 * hr * hr * hr);
                
                case 'exponential':
                    return nugget + partialSill * (1 - Math.exp(-3 * h / range));
                
                case 'gaussian':
                    return nugget + partialSill * (1 - Math.exp(-3 * (h / range) * (h / range)));
                
                case 'linear':
                    if (h >= range) return sill;
                    return nugget + partialSill * h / range;
                
                case 'nugget':
                    return sill;
                
                default:
                    return sill;
            }
        }

        function covariance(h, type, nugget, sill, range) {
            return sill - variogram(h, type, nugget, sill, range);
        }

        // ============ ä½¿ç”¨Choleskyç”Ÿæˆé«˜æ–¯éšæœºåœº ============
        function generateRandomFieldCholesky(gridSize, type, nugget, sill, range, anisotropy) {
            try {
                const n = gridSize;
                const N = n * n;
                const lx = range / 3;
                const ly = lx / anisotropy;
                const epsilon = 1e-10 * sill; // æ•°å€¼æ­£åˆ™åŒ–
                
                console.log(`ç”Ÿæˆ ${n}x${n} éšæœºåœº (Cholesky), N=${N}, lx=${lx.toFixed(2)}, ly=${ly.toFixed(2)}, epsilon=${epsilon}`);
                
                // æ­¥éª¤1ï¼šæ„å»ºåæ–¹å·®çŸ©é˜µï¼ˆå¯¹ç§°ï¼‰
                const covMat = Array.from({length: N}, () => new Float64Array(N));
                for (let p = 0; p < N; p++) {
                    const i1 = Math.floor(p / n);
                    const j1 = p % n;
                    covMat[p][p] = sill;
                    for (let q = 0; q < p; q++) {
                        const i2 = Math.floor(q / n);
                        const j2 = q % n;
                        const dx = i1 - i2;
                        const dy = j1 - j2;
                        const hh = Math.sqrt((dx / lx) ** 2 + (dy / ly) ** 2);
                        const c = covariance(hh, type, nugget, sill, range);
                        covMat[p][q] = c;
                        covMat[q][p] = c;
                    }
                }
                
                // æ·»åŠ å¯¹è§’æ­£åˆ™åŒ–
                for (let p = 0; p < N; p++) {
                    covMat[p][p] += epsilon;
                }
                
                // æ­¥éª¤2ï¼šCholeskyåˆ†è§£
                const L = choleskyDecomposition(covMat);
                
                // æ­¥éª¤3ï¼šç”Ÿæˆéšæœºå‘é‡ Z
                const Z = new Float64Array(N);
                for (let i = 0; i < N; i++) {
                    Z[i] = gaussianRandom();
                }
                
                // æ­¥éª¤4ï¼šX = L * Z
                const field = new Float64Array(N);
                for (let i = 0; i < N; i++) {
                    let sum = 0;
                    for (let j = 0; j <= i; j++) {
                        sum += L[i][j] * Z[j];
                    }
                    field[i] = sum;
                }
                
                // æ­¥éª¤5ï¼šæ ‡å‡†åŒ–
                const stats = calculateStats(field);
                const targetStd = Math.sqrt(sill);
                
                if (stats.std > 1e-10) {
                    for (let i = 0; i < N; i++) {
                        field[i] = (field[i] - stats.mean) / stats.std * targetStd;
                    }
                }
                
                console.log('éšæœºåœºç”ŸæˆæˆåŠŸ');
                return field;
                
            } catch (error) {
                console.error('ç”Ÿæˆéšæœºåœºæ—¶å‡ºé”™:', error);
                throw error;
            }
        }

        // ============ ç»Ÿè®¡è®¡ç®— ============
        function calculateStats(field) {
            const n = field.length;
            let sum = 0, sum2 = 0;
            let min = Infinity, max = -Infinity;
            
            for (let i = 0; i < n; i++) {
                sum += field[i];
                sum2 += field[i] * field[i];
                min = Math.min(min, field[i]);
                max = Math.max(max, field[i]);
            }
            
            const mean = sum / n;
            const variance = sum2 / n - mean * mean;
            const std = Math.sqrt(Math.max(0, variance));
            
            return { mean, std, min, max };
        }

        // ============ å¯è§†åŒ– ============
        function drawField(canvas, field, gridSize) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const cellSize = width / gridSize;
            
            const stats = calculateStats(field);
            const range = Math.max(stats.max - stats.min, 1e-10);
            
            ctx.clearRect(0, 0, width, height);
            
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const value = field[i * gridSize + j];
                    const normalized = (value - stats.min) / range;
                    
                    // ä½¿ç”¨å†·æš–è‰²è°ƒ
                    const hue = 240 - normalized * 240;
                    const lightness = 30 + normalized * 40;
                    ctx.fillStyle = `hsl(${hue}, 80%, ${lightness}%)`;
                    
                    ctx.fillRect(j * cellSize, i * cellSize, Math.ceil(cellSize) + 1, Math.ceil(cellSize) + 1);
                }
            }
            
            return stats;
        }

        function drawVariogram(canvas, type, nugget, sill, range) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 60;
            const plotWidth = width - 2 * padding;
            const plotHeight = height - 2 * padding;
            
            ctx.clearRect(0, 0, width, height);
            
            // èƒŒæ™¯
            ctx.fillStyle = '#f9f9f9';
            ctx.fillRect(padding, padding, plotWidth, plotHeight);
            
            // ç½‘æ ¼
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = padding + (plotWidth * i / 10);
                const y = padding + (plotHeight * i / 10);
                
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, padding + plotHeight);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + plotWidth, y);
                ctx.stroke();
            }
            
            // åæ ‡è½´
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding + plotHeight);
            ctx.lineTo(padding + plotWidth, padding + plotHeight);
            ctx.lineTo(padding + plotWidth - 10, padding + plotHeight - 5);
            ctx.moveTo(padding + plotWidth, padding + plotHeight);
            ctx.lineTo(padding + plotWidth - 10, padding + plotHeight + 5);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(padding, padding + plotHeight);
            ctx.lineTo(padding, padding);
            ctx.lineTo(padding - 5, padding + 10);
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding + 5, padding + 10);
            ctx.stroke();
            
            // å˜å·®å‡½æ•°æ›²çº¿
            const maxH = range * 2.5;
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            for (let i = 0; i <= 200; i++) {
                const h = (maxH * i / 200);
                const gamma = variogram(h, type, nugget, sill, range);
                const x = padding + (h / maxH) * plotWidth;
                const y = padding + plotHeight - (gamma / (sill * 1.2)) * plotHeight;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // å…³é”®å‚æ•°çº¿
            const sillY = padding + plotHeight - (sill / (sill * 1.2)) * plotHeight;
            ctx.strokeStyle = '#27ae60';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(padding, sillY);
            ctx.lineTo(padding + plotWidth, sillY);
            ctx.stroke();
            
            if (nugget > 0.01) {
                const nuggetY = padding + plotHeight - (nugget / (sill * 1.2)) * plotHeight;
                ctx.strokeStyle = '#f39c12';
                ctx.beginPath();
                ctx.moveTo(padding, nuggetY);
                ctx.lineTo(padding + plotWidth, nuggetY);
                ctx.stroke();
            }
            
            const rangeX = padding + (range / maxH) * plotWidth;
            ctx.strokeStyle = '#3498db';
            ctx.beginPath();
            ctx.moveTo(rangeX, padding);
            ctx.lineTo(rangeX, padding + plotHeight);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // æ ‡ç­¾
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('è·ç¦» h', padding + plotWidth / 2, height - 20);
            
            ctx.save();
            ctx.translate(20, padding + plotHeight / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('å˜å·® Î³(h)', 0, 0);
            ctx.restore();
            
            // å›¾ä¾‹
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#27ae60';
            ctx.fillText(`åŸºå°å€¼: ${sill.toFixed(2)}`, padding + 20, padding + 20);
            if (nugget > 0.01) {
                ctx.fillStyle = '#f39c12';
                ctx.fillText(`å—é‡‘å€¼: ${nugget.toFixed(2)}`, padding + 20, padding + 40);
            }
            ctx.fillStyle = '#3498db';
            ctx.fillText(`å˜ç¨‹: ${range.toFixed(0)}`, padding + 20, padding + 60);
            
            // åˆ»åº¦
            ctx.fillStyle = '#666';
            ctx.font = '11px Arial';
            ctx.textAlign = 'center';
            for (let i = 0; i <= 5; i++) {
                const x = padding + (plotWidth * i / 5);
                const label = (maxH * i / 5).toFixed(0);
                ctx.fillText(label, x, padding + plotHeight + 20);
            }
            
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const y = padding + plotHeight - (plotHeight * i / 5);
                const label = (sill * 1.2 * i / 5).toFixed(2);
                ctx.fillText(label, padding - 10, y + 4);
            }
        }

        // ============ ä¸»å‡½æ•° ============
        function generateFields() {
            try {
                const type = document.getElementById('variogramType').value;
                const nugget = parseFloat(document.getElementById('nugget').value);
                const sill = parseFloat(document.getElementById('sill').value);
                const range = parseFloat(document.getElementById('range').value);
                const gridSize = parseInt(document.getElementById('gridSize').value);
                const anisotropy = parseFloat(document.getElementById('anisotropy').value);
                
                if (gridSize > 128 || gridSize < 8 || gridSize % 8 !== 0) {
                    alert('ç½‘æ ¼å¤§å°å¿…é¡»æ˜¯8çš„å€æ•°ï¼Œä¸”â‰¤128ã€‚Choleskyæ–¹æ³•è®¡ç®—å¯†é›†ï¼Œå¤§ç½‘æ ¼å¯èƒ½éå¸¸æ…¢æˆ–å†…å­˜ä¸è¶³ã€‚');
                    return;
                }
                
                console.log('ç”Ÿæˆéšæœºåœºå‚æ•°:', { type, nugget, sill, range, gridSize, anisotropy });
                
                // ç”Ÿæˆä¸¤ä¸ªç‹¬ç«‹çš„éšæœºåœº
                const field1 = generateRandomFieldCholesky(gridSize, type, nugget, sill, range, anisotropy);
                const field2 = generateRandomFieldCholesky(gridSize, type, nugget, sill, range, anisotropy);
                
                // ç»˜åˆ¶éšæœºåœº
                const canvas1 = document.getElementById('field1');
                const canvas2 = document.getElementById('field2');
                
                const stats1 = drawField(canvas1, field1, gridSize);
                const stats2 = drawField(canvas2, field2, gridSize);
                
                console.log('éšæœºåœº1ç»Ÿè®¡:', stats1);
                console.log('éšæœºåœº2ç»Ÿè®¡:', stats2);
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('mean1').textContent = stats1.mean.toFixed(3);
                document.getElementById('std1').textContent = stats1.std.toFixed(3);
                document.getElementById('min1').textContent = stats1.min.toFixed(3);
                document.getElementById('max1').textContent = stats1.max.toFixed(3);
                
                document.getElementById('mean2').textContent = stats2.mean.toFixed(3);
                document.getElementById('std2').textContent = stats2.std.toFixed(3);
                document.getElementById('min2').textContent = stats2.min.toFixed(3);
                document.getElementById('max2').textContent = stats2.max.toFixed(3);
                
                // ç»˜åˆ¶å˜å·®å‡½æ•°
                const variogramCanvas = document.getElementById('variogram');
                drawVariogram(variogramCanvas, type, nugget, sill, range);
                
                console.log('éšæœºåœºç”Ÿæˆå®Œæˆï¼');
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                alert('ç”Ÿæˆéšæœºåœºå¤±è´¥: ' + error.message + '\nå¯èƒ½ç”±äºç½‘æ ¼è¿‡å¤§æˆ–å†…å­˜ä¸è¶³ã€‚å°è¯•è°ƒæ•´å‚æ•°æˆ–ä½¿ç”¨è¾ƒå°ç½‘æ ¼ã€‚');
            }
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            console.log('åˆå§‹åŒ–æ¼”ç¤ºç³»ç»Ÿ');
            generateFields();
        };
    </script>
</body>
</html>